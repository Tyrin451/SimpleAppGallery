<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PWA Media Gallery</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Global Styles */
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-color: #333333;
            --nav-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            /* Prevent body scroll, handle in views if needed */
            height: 100vh;
            width: 100vw;
        }

        /* Layout & Views */
        #app {
            height: 100%;
            width: 100%;
            position: relative;
        }

        .view {
            height: calc(100% - var(--nav-height));
            width: 100%;
            display: none;
            /* Hidden by default */
            overflow-y: auto;
        }

        .view.active {
            display: block;
        }

        /* Navigation */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background-color: #111;
            border-top: 1px solid #222;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        nav button {
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: color 0.2s;
        }

        nav button.active {
            color: #fff;
        }

        /* Configuration View */
        #view-config {
            padding: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #view-config.active {
            display: flex;
        }

        textarea#media-source {
            width: 100%;
            height: 70vh;
            background-color: #111;
            color: #ccc;
            border: 1px solid #333;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            resize: none;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        button#save-btn {
            background-color: #fff;
            color: #000;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
        }

        /* Gallery View */
        #view-gallery {
            position: relative;
            /* For absolute overlay positioning */
            height: calc(100% - var(--nav-height));
            display: none;
            background-color: #000;
            /* Centering media */
            justify-content: center;
            align-items: center;
        }

        #view-gallery.active {
            display: flex;
        }

        #media-container {
            width: 100%;
            height: 100%;
            /* Occupy full area above nav */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #media-container img,
        #media-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Default */
            display: block;
            transition: object-fit 0.2s ease;
        }

        #media-container img.scale-fill,
        #media-container video.scale-fill {
            object-fit: cover;
        }

        .placeholder-text {
            color: #666;
            font-size: 1.2rem;
            text-align: center;
        }

        /* Scaling Button */
        #scale-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* Overlay Controls */
        .click-zone {
            position: absolute;
            top: 0;
            height: 100%;
            width: 30%;
            z-index: 10;
            /* background: rgba(255, 0, 0, 0.1); Debugging */
        }

        .click-zone.left {
            left: 0;
        }

        .click-zone.right {
            right: 0;
        }

        /* Helpers */
        .hidden {
            display: none !important;
        }

        /* Evaluation Controls */
        #eval-controls {
            position: absolute;
            bottom: 20px;
            /* Relative to the gallery view which ends at nav bar */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 500;
        }

        .btn-vote {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #555;
            color: #fff;
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-vote:active {
            transform: scale(0.95);
        }

        .btn-vote.active.up {
            background: rgba(46, 204, 113, 0.8);
            /* Green */
            border-color: #2ecc71;
        }

        .btn-vote.active.down {
            background: rgba(231, 76, 60, 0.8);
            /* Red */
            border-color: #e74c3c;
        }

        #btn-download {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }

        #btn-reset {
            background-color: transparent;
            color: #666;
            border: 1px solid #333;
            padding: 8px 15px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 30px;
        }
    </style>
</head>

<body>

    <div id="app">
        <!-- Configuration View -->
        <div id="view-config" class="view active">
            <textarea id="media-source"
                placeholder="Coller une URL par ligne...&#10;https://example.com/image.jpg&#10;https://example.com/video.mp4"></textarea>
            <button id="save-btn">CHARGER / SAUVEGARDER</button>
            <button id="btn-download">T√âL√âCHARGER JSON</button>
            <button id="btn-reset">R√âINITIALISER L'APPLICATION (Vider cache/data)</button>
        </div>

        <!-- Gallery View -->
        <div id="view-gallery" class="view">
            <button id="scale-btn">FIT</button>
            <div id="media-container">
                <!-- Media will be injected here -->
                <div class="placeholder-text">Aucun m√©dia charg√©</div>
            </div>

            <div id="eval-controls">
                <button class="btn-vote down" id="btn-thumb-down">üëé</button>
                <button class="btn-vote up" id="btn-thumb-up">üëç</button>
            </div>
            <!-- Touchable zones for navigation -->
            <div class="click-zone left" id="zone-prev"></div>
            <div class="click-zone right" id="zone-next"></div>
        </div>
    </div>

    <nav>
        <button id="nav-config" class="active">Configuration</button>
        <button id="nav-gallery">Galerie</button>
    </nav>

    <script>
        /**
         * Application State
         */
        const state = {
            currentIndex: 0,
            mediaList: [],
            evaluations: {}, // format: { url: 'good' | 'bad' }
            scaleMode: 'contain' // 'contain' (Fit) or 'cover' (Fill)
        };

        /**
         * Constants & Elements
         */
        const STORAGE_KEY = 'media_gallery_source';
        const EVAL_STORAGE_KEY = 'media_gallery_evaluations';
        const els = {
            viewConfig: document.getElementById('view-config'),
            viewGallery: document.getElementById('view-gallery'),
            navConfig: document.getElementById('nav-config'),
            navGallery: document.getElementById('nav-gallery'),
            textarea: document.getElementById('media-source'),
            saveBtn: document.getElementById('save-btn'),
            downloadBtn: document.getElementById('btn-download'),
            mediaContainer: document.getElementById('media-container'),
            zonePrev: document.getElementById('zone-prev'),
            zoneNext: document.getElementById('zone-next'),
            scaleBtn: document.getElementById('scale-btn'),
            btnThumbUp: document.getElementById('btn-thumb-up'),
            btnThumbDown: document.getElementById('btn-thumb-down'),
            resetBtn: document.getElementById('btn-reset')
        };

        /**
         * Initialization of Service Worker
         */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }

        /**
         * Init Application
         */
        function init() {
            // Load data from Storage
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                els.textarea.value = storedData;
                parseAndLoadState(storedData);
            }

            const storedEvals = localStorage.getItem(EVAL_STORAGE_KEY);
            if (storedEvals) {
                try {
                    state.evaluations = JSON.parse(storedEvals);
                } catch (e) {
                    console.error('Failed to parse evaluations', e);
                }
            }

            const storedScale = localStorage.getItem('media_gallery_scale');
            if (storedScale) {
                state.scaleMode = storedScale;
                updateScaleBtn();
            }

            // Event Listeners
            els.saveBtn.addEventListener('click', handleSave);
            els.downloadBtn.addEventListener('click', downloadJSON);

            els.btnThumbUp.addEventListener('click', () => vote('good'));
            els.btnThumbDown.addEventListener('click', () => vote('bad'));
            els.resetBtn.addEventListener('click', handleReset);

            els.navConfig.addEventListener('click', () => switchView('config'));
            els.navGallery.addEventListener('click', () => {
                handleSave(); // Auto-save on switch
                switchView('gallery');
            });

            els.scaleBtn.addEventListener('click', toggleScale);

            // Navigation Inputs
            els.zonePrev.addEventListener('click', prevMedia);
            els.zoneNext.addEventListener('click', nextMedia);
            document.addEventListener('keydown', handleKeyNav);

            // Swipe gestures
            let touchStartX = 0;
            let touchEndX = 0;

            els.viewGallery.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            els.viewGallery.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const threshold = 50;
                if (touchEndX < touchStartX - threshold) {
                    nextMedia(); // Swipe Left -> Next
                }
                if (touchEndX > touchStartX + threshold) {
                    prevMedia(); // Swipe Right -> Prev
                }
            }
        }

        /**
         * Core Logic
         */
        function handleSave() {
            const rawText = els.textarea.value;
            localStorage.setItem(STORAGE_KEY, rawText);
            parseAndLoadState(rawText);
            // Visual feedback could be added here
            console.log('Saved', state.mediaList.length, 'items');
        }

        function parseAndLoadState(text) {
            if (!text) {
                state.mediaList = [];
                return;
            }
            state.mediaList = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && (line.startsWith('http') || line.startsWith('blob:') || line.startsWith('data:'))); // Basic validation

            console.log('Media list updated. Count:', state.mediaList.length);

            // Reset index if out of bounds, otherwise keep it (unless list is empty)
            if (state.currentIndex >= state.mediaList.length) {
                state.currentIndex = 0;
            }
        }

        function switchView(viewName) {
            if (viewName === 'config') {
                els.viewConfig.classList.add('active');
                els.viewGallery.classList.remove('active');
                els.navConfig.classList.add('active');
                els.navGallery.classList.remove('active');

                // Allow native scrolling for config
                document.body.style.overflow = 'hidden';

                // Pause any playing video when switching to config
                const currentVideo = els.mediaContainer.querySelector('video');
                if (currentVideo) currentVideo.pause();

            } else {
                // Validation before switching
                if (state.mediaList.length === 0) {
                    alert("Aucune URL valide trouv√©e. Veuillez en ajouter dans la configuration.");
                    return;
                }

                els.viewConfig.classList.remove('active');
                els.viewGallery.classList.add('active');
                els.navConfig.classList.remove('active');
                els.navGallery.classList.add('active');

                console.log('Switching to gallery. Index:', state.currentIndex, 'List length:', state.mediaList.length);

                renderMedia(state.currentIndex);
            }
        }

        /**
         * Gallery Logic
         */
        function renderMedia(index) {
            if (state.mediaList.length === 0) return;

            // Cleanup previous - Explicitly pause video if exists
            const oldVideo = els.mediaContainer.querySelector('video');
            if (oldVideo) {
                oldVideo.pause();
                oldVideo.removeAttribute('src'); // Helper to clear buffer
                oldVideo.load();
            }
            els.mediaContainer.innerHTML = '';

            const url = state.mediaList[index];
            const isVideo = isVideoUrl(url);

            let mediaEl;
            if (isVideo) {
                mediaEl = document.createElement('video');
                mediaEl.src = url;
                mediaEl.controls = true;
                mediaEl.autoplay = true;
                mediaEl.loop = true;
                mediaEl.muted = true; // Required for autoplay
                mediaEl.playsInline = true;
            } else {
                mediaEl = document.createElement('img');
                mediaEl.src = url;
                mediaEl.alt = "Media content";
            }

            mediaEl.onerror = () => {
                els.mediaContainer.innerHTML = '<div class="placeholder-text">Erreur de chargement <br> <span style="font-size:0.8em; color:#444">' + url + '</span></div>';
            };

            els.mediaContainer.appendChild(mediaEl);
            applyScaleMode(mediaEl);

            // Preload next
            preloadNext(index);

            updateEvalButtons();
        }

        function updateEvalButtons() {
            const currentUrl = state.mediaList[state.currentIndex];
            const status = state.evaluations[currentUrl];

            els.btnThumbUp.classList.remove('active');
            els.btnThumbDown.classList.remove('active');

            if (status === 'good') els.btnThumbUp.classList.add('active');
            if (status === 'bad') els.btnThumbDown.classList.add('active');
        }

        function vote(status) {
            if (state.mediaList.length === 0) return;
            const currentUrl = state.mediaList[state.currentIndex];

            // Toggle if clicking same
            if (state.evaluations[currentUrl] === status) {
                delete state.evaluations[currentUrl];
            } else {
                state.evaluations[currentUrl] = status;
            }

            localStorage.setItem(EVAL_STORAGE_KEY, JSON.stringify(state.evaluations));
            updateEvalButtons();
        }

        function downloadJSON() {
            const result = state.mediaList.map(url => ({
                url: url,
                result: state.evaluations[url] || 'none'
            }));

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(result, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "evaluations.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleReset() {
            if (confirm("Voulez-vous r√©initialiser l'application ? Cela videra toutes les URLs et les √©valuations.")) {
                localStorage.clear();
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        for (let registration of registrations) {
                            registration.unregister();
                        }
                    });
                }
                location.reload(true);
            }
        }

        function toggleScale() {
            state.scaleMode = state.scaleMode === 'contain' ? 'cover' : 'contain';
            localStorage.setItem('media_gallery_scale', state.scaleMode);

            const mediaEl = els.mediaContainer.querySelector('img, video');
            if (mediaEl) {
                applyScaleMode(mediaEl);
            }
            updateScaleBtn();
        }

        function applyScaleMode(el) {
            if (state.scaleMode === 'cover') {
                el.classList.add('scale-fill');
            } else {
                el.classList.remove('scale-fill');
            }
        }

        function updateScaleBtn() {
            els.scaleBtn.innerText = state.scaleMode === 'contain' ? 'FIT' : 'FILL';
        }

        function isVideoUrl(url) {
            // Simple extension check
            return /\.(mp4|webm|ogg)($|\?)/i.test(url);
        }

        function nextMedia(e) {
            if (e) e.stopPropagation();
            if (state.mediaList.length === 0) return;
            state.currentIndex = (state.currentIndex + 1) % state.mediaList.length;
            renderMedia(state.currentIndex);
        }

        function prevMedia(e) {
            if (e) e.stopPropagation();
            if (state.mediaList.length === 0) return;
            state.currentIndex = (state.currentIndex - 1 + state.mediaList.length) % state.mediaList.length;
            renderMedia(state.currentIndex);
        }

        function handleKeyNav(e) {
            // Only active if gallery is visible
            if (!els.viewGallery.classList.contains('active')) return;

            if (e.key === 'ArrowRight') nextMedia();
            if (e.key === 'ArrowLeft') prevMedia();
            if (e.key === 'ArrowRight') nextMedia();
            if (e.key === 'ArrowLeft') prevMedia();
            if (e.key === 'ArrowUp') vote('good');
            if (e.key === 'ArrowDown') vote('bad');
        }

        function preloadNext(currentIndex) {
            if (state.mediaList.length <= 1) return;
            const nextIndex = (currentIndex + 1) % state.mediaList.length;
            const nextUrl = state.mediaList[nextIndex];

            if (!isVideoUrl(nextUrl)) {
                const img = new Image();
                img.src = nextUrl;
            }
            // Video preloading is more complex and memory heavy, skipping for now as per plan focus on images first or strict memory mgmt
        }

        // Run
        init();

    </script>
</body>

</html>